<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8"/>
  <meta name="keywords" content=""/>
  <meta name="description" content=""/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>MXD Desgin Week - Ranking</title>
  <link rel="shortcut icon" href="#"/>
  <link rel="stylesheet" href="../css/g.scss"/>
  <link rel="stylesheet" href="../css/index.scss"/>
  <script src="../js/jquery-3.1.0.min.js"></script>
</head>
<body>

<video class="bg-video" poster="../img/bg.png" autoplay loop>
  <source src="../img/bg.mp4" type="video/mp4">
</video>



<div class="container">
  <div class="left-cont">
    <div class="title-wrap">
      <span class="logo"></span>
      <p class="title-latest-score">最新成绩</p>
    </div>
    <div class="mbd-score-wrap">
      <ul class="mbd-score-list">
        <!-- <li class="mbd-score-item">
          <div class="mbd-score-avatar">
            <img src="http://wx.qlogo.cn/mmopen/ajNVdqHZLLDFVzZGAiatZQIickC2RKVBrgz141c8c8dkeNUmrsUHH7BDR4Qj1qPnibBl7TuTSaE9YWYnuYIwxSlULj2Yey9ajOCgIWfTaia0OcM/0" alt="Unicorn" class="mbd-avatar-img">
          </div><div class="mbd-score-resl">
            <b class="mbd-score-name">Unicorn</b>
            <span class="mbd-score-time">30分钟</span>
            <span class="mbd-score-gift">抱枕1个&nbsp;<b class="status">未认领</b></span>
          </div>
        </li> -->
      </ul>
    </div>
  </div>

  <div class="right-cont">
    <div class="title-wrap">
      <p class="title-latest-onbaord">最新上榜</p>
    </div>

    <ul class="mbd-best-list">
      <!-- <li class="mbd-best-item">
        <span class="mbd-best-props gold"></span>
        <div class="mbd-best-avatar">
          <img src="http://wx.qlogo.cn/mmopen/ajNVdqHZLLDFVzZGAiatZQIickC2RKVBrgz141c8c8dkeNUmrsUHH7BDR4Qj1qPnibBl7TuTSaE9YWYnuYIwxSlULj2Yey9ajOCgIWfTaia0OcM/0" alt="Unicorn" class="mbd-avatar-img">
        </div><div class="mbd-best-resl">
          <p class="mbd-best-name">Kikizhu</p>
          <b class="mbd-best-time">26分钟</b>
        </div>
      </li>
      <li class="mbd-best-item">
        <span class="mbd-best-props silver"></span>
        <div class="mbd-best-avatar">
          <img src="http://wx.qlogo.cn/mmopen/ajNVdqHZLLDFVzZGAiatZQIickC2RKVBrgz141c8c8dkeNUmrsUHH7BDR4Qj1qPnibBl7TuTSaE9YWYnuYIwxSlULj2Yey9ajOCgIWfTaia0OcM/0" alt="Unicorn" class="mbd-avatar-img">
        </div><div class="mbd-best-resl">
          <p class="mbd-best-name">Kikizhu</p>
          <b class="mbd-best-time">26分钟</b>
        </div>
      </li>

      <li class="mbd-best-item">
        <span class="mbd-best-props copper"></span>
        <div class="mbd-best-avatar">
          <img src="http://wx.qlogo.cn/mmopen/ajNVdqHZLLDFVzZGAiatZQIickC2RKVBrgz141c8c8dkeNUmrsUHH7BDR4Qj1qPnibBl7TuTSaE9YWYnuYIwxSlULj2Yey9ajOCgIWfTaia0OcM/0" alt="Unicorn" class="mbd-avatar-img">
        </div><div class="mbd-best-resl">
          <p class="mbd-best-name">Kikizhu</p>
          <b class="mbd-best-time">26分钟</b>
        </div>
      </li> -->
      <!-- <li class="mbd-best-item">
        <span class="mbd-best-props air"></span>
        <div class="mbd-best-avatar">
          <img src="http://wx.qlogo.cn/mmopen/ajNVdqHZLLDFVzZGAiatZQIickC2RKVBrgz141c8c8dkeNUmrsUHH7BDR4Qj1qPnibBl7TuTSaE9YWYnuYIwxSlULj2Yey9ajOCgIWfTaia0OcM/0" alt="Unicorn" class="mbd-avatar-img">
        </div><div class="mbd-best-resl">
          <p class="mbd-best-name">Kikizhugdd</p>
          <b class="mbd-best-time">26分钟</b>
        </div>
      </li> -->
    </ul>
  </div>
</div>


<script>
$(function() {

  function AJAX(method, URL, async, type, callback, data) {
    var xml = new XMLHttpRequest();
    xml.responseType = type;
    xml.onreadystatechange = function() {
      if (xml.readyState == 4 && xml.status == 200) {
        var getRes = xml.response;
        callback(getRes);
      }
    };
    xml.onerror = function (e) {
      console.error(e);
    };
    xml.open(method, URL, async);
    xml.withCredentials = true;
    if (data) {
      xml.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
      xml.send(data);
    } else {
      xml.send();
    }
  }

  $('.mbd-score-list').children('li').each(function(index, el){
    $(el).addClass('show');
  });

  function timeSince(seconds) {
    if(seconds < 60){
      return parseInt(seconds) + '秒';
    }
    if(seconds < 3600){
      return parseInt(seconds/60) + '分钟' + parseInt(seconds%60) + '秒';
    }
    if(seconds <= 86400){
      return parseInt(seconds/3600) + '小时' + parseInt((seconds%3600)/60) + '分';
    }
    if(seconds > 86400){
      var date = new Date(seconds * 1000);
      var day = date.getDate();
      var month = date.toDateString().match(/[a-zA-Z]*/)[0].replace(" ","");
      var year = date.getFullYear() == now.getFullYear() ? "" :  " " + date.getFullYear();
      return day + " " + month + year;
    }
  }

  function toReadableTime(ms) {
    if (!ms) return;
    var time = new Date(parseInt(ms));
    var seconds = parseInt(ms / 1000);
    if(seconds < 60){
      return time.getSeconds() + '秒';
    }
    if(seconds < 3600){
      return time.getMinutes() + '分钟' + time.getSeconds() + '秒';
    }
    if(seconds <= 86400){
      return time.getHours() + '小时' + time.getMinutes() + '分';
    }
  }

  function newestListCb(data) {
    var result = JSON.parse(data);

    var getNewItem = function(newest) {
      var time = toReadableTime(newest.time);

      var li = $('<li />', {class: 'mbd-score-item'});
      var imgDiv = $('<div />', {class: 'mbd-score-avatar'});
      var reslDiv = $('<div />', {class: 'mbd-score-resl'});

      var imgScr = 'data:image/gif;base64,R0lGODlhAQABAIAAAMLCwgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==';
      if (newest.info && newest.info != 'NULL' && newest.info != '') {
        imgScr = decodeURI(newest.info);
      }
      $('<img/>', {
        class: 'mbd-avatar-img',
        alt: newest.name,
        src: imgScr
      }).appendTo(imgDiv)

      $('<b />', {
        class: 'mbd-score-name',
        text: newest.name
      }).appendTo(reslDiv)
      $('<span />', {
        class: 'mbd-score-time',
        text: time
      }).appendTo(reslDiv)
      $('<span />', {
        class: 'mbd-score-gift',
        text: newest.gift + ' '
      }).append($('<b />', {
        class: 'status',
        text: newest.ifUsed == 0 ? '未认领' : '已认领'
      })).appendTo(reslDiv)

      li.append(imgDiv).append(reslDiv);
      return li;
    }

    var newestList = $('.mbd-score-list');
    if ( newestList.children().length > 7 ) {
      var newest = result[result.length - 1];
      var li = getNewItem(newest);
      newestList.children().slice(-1).remove();
      newestList.prepend(li);
      li.addClass('show');
    } else if (newestList.children().length + result.length > 7) {
      var lp = 8 - newestList.children().length;
      for (var i = result.length - 1; i >= result.length - lp; i--) {
        var newest = result[i];
        var li = getNewItem(newest);
        newestList.prepend(li);
        li.addClass('show');      }
    } else {
      for (var i = result.length - 1; i >= 0; i--) {
        var newest = result[i];
        var li = getNewItem(newest);
        newestList.prepend(li);
        li.addClass('show');
      }
    }
  }

  function bestListCb(data) {
    var result = JSON.parse(data);

    var getNewItem = function(best, rank) {
      var time = toReadableTime(best.time);
      var li = $('<li />', {class: 'mbd-best-item'});
      var imgDiv = $('<div />', {class: 'mbd-best-avatar'});
      var reslDiv = $('<div />', {class: 'mbd-best-resl'});
      var spanProps = $('<div />', { class: 'mbd-best-props ' + rank});

      var imgScr = 'data:image/gif;base64,R0lGODlhAQABAIAAAMLCwgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==';
      if (best.info && best.info != 'NULL' && best.info != '') {
        imgScr = decodeURI(best.info);
      }

      $('<img/>', {
        class: 'mbd-avatar-img',
        alt: best.name,
        src: imgScr
      }).appendTo(imgDiv)

      $('<p />', {
        class: 'mbd-best-name',
        text: best.name
      }).appendTo(reslDiv)
      $('<b />', {
        class: 'mbd-best-time',
        text: time
      }).appendTo(reslDiv)

      li.append(spanProps).append(imgDiv).append(reslDiv);
      return li;
    }

    var bestList = $('.mbd-best-list');
    bestList.empty();
    for (var i = 0; i < 4; i++) {
      var best = result[i];
      var rank = '';
      if (i == 0) {
        rank = 'gold'
      } else if (i == 1) {
        rank = 'silver'
      } else if (i == 2) {
        rank = 'copper'
      } else if (i == 3) {
        rank = 'air';
      }
      var li = getNewItem(best, rank);
      bestList.append(li);
      if (i < 3) {
        li.addClass('show');
      }
    }
    setTimeout(function() {
      bestList.children().last().addClass('show');
    }, 1000);
  }

  var host = '//mxd.tencent.com/weixin/160818-mbd/server/';
  var newestIntvl = null,
    baseIntvl = null;
  // newest list
  newestIntvl = setInterval(function() {
    var method = 'GET';
    var url = host + 'ajax?rank=true&getAll=true';
    var type = 'text';
    AJAX(method, url, true, type, newestListCb, {});
  }, 5000);

  // best list
  baseIntvl = setInterval(function() {
    var method = 'GET';
    var url = host + 'ajax?rank=true&order=time';
    var type= 'text';
    AJAX(method, url, true, type, bestListCb, {});
  }, 5000);

});
</script>
</body>
</html>
